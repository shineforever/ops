var brands = [{"name":"奥迪","path":"/china/aodi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"阿尔法罗密欧","path":"/china/aerfaluomiou/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"阿斯顿·马丁","path":"/china/asidunmading/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"安凯客车","path":"/china/ankaikeche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"北汽幻速","path":"/china/beiqihuansu/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"宝骏","path":"/china/baojun/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"巴博斯","path":"/china/babosi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"北汽威旺","path":"/china/beiqiweiwang/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"北汽制造","path":"/china/beiqizhizao/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"奔驰","path":"/china/benchi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"布加迪","path":"/china/bujiadi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"别克","path":"/china/bieke/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"宾利","path":"/china/binli/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"保时捷","path":"/china/baoshijie/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"比亚迪","path":"/china/biyadi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"奔腾","path":"/china/benteng/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"标致","path":"/china/biaozhi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"本田","path":"/china/bentian/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"宝马","path":"/china/baoma/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"北京汽车","path":"/china/beijingqiche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"昌河","path":"/china/changhe/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"长安","path":"/china/changan/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"长城","path":"/china/changcheng/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"长安商用","path":"/china/changanshangyong/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"成功汽车","path":"/china/chenggongqiche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"东风风度","path":"/china/dongfengfengdu/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"东风风行","path":"/china/dongfengfengxing/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"DS","path":"/china/ds/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"东风小康","path":"/china/dongfengxiaokang/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"东风风神","path":"/china/dongfengfengshen/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"东南","path":"/china/dongnan/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"道奇","path":"/china/daoqi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"大发","path":"/china/dafa/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"东风","path":"/china/dongfeng/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"大众","path":"/china/dazhong/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"丰田","path":"/china/fengtian/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"福特","path":"/china/fute/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"菲亚特","path":"/china/feiyate/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"福田","path":"/china/futian/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"法拉利","path":"/china/falali/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"福迪","path":"/china/fudi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"福汽启腾","path":"/china/fuqiqiteng/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"观致","path":"/china/guanzhi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"GMC","path":"/china/gmc/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"广汽吉奥","path":"/china/guangqijiao/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"广汽传祺","path":"/china/guangqichuanzuo/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"悍马","path":"/china/hanma/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"黄海","path":"/china/huanghai/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"红旗","path":"/china/hongqi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"华普","path":"/china/huapu/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"海马","path":"/china/haima/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"华泰","path":"/china/huatai/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"哈飞","path":"/china/hafei/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"海格","path":"/china/haige/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"哈弗","path":"/china/hafu/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"恒天","path":"/china/hengtian/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"江铃集团轻汽","path":"/china/jianglingjituanqingqi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"金旅","path":"/china/jinlv/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"九龙","path":"/china/jiulong/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"江铃","path":"/china/jiangling/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"金龙","path":"/china/jinlong/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"吉利汽车","path":"/china/jiliqiche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"Jeep","path":"/china/jeep/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"捷豹","path":"/china/jiebao/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"金杯","path":"/china/jinbei/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"江淮","path":"/china/jianghuai/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"开瑞","path":"/china/kairui/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"凯迪拉克","path":"/china/kaidilake/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"克莱斯勒","path":"/china/kelaisile/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"卡升","path":"/china/kasheng/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"卡威","path":"/china/kawei/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"雷丁","path":"/china/leiding/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"理念","path":"/china/linian/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"雷诺","path":"/china/leinuo/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"兰博基尼","path":"/china/lanbojini/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"路虎","path":"/china/luhu/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"路特斯","path":"/china/lutesi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"林肯","path":"/china/linken/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"雷克萨斯","path":"/china/leikesasi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"铃木","path":"/china/lingmu/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"劳斯莱斯","path":"/china/laosilaisi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"陆风","path":"/china/lufeng/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"莲花汽车","path":"/china/lianhuaqiche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"力帆","path":"/china/lifan/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"猎豹汽车","path":"/china/liebaoqiche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"迈巴赫","path":"/china/maibahe/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"MINI","path":"/china/mini/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"玛莎拉蒂","path":"/china/mashaladi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"马自达","path":"/china/mazida/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"MG","path":"/china/mg/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"迈凯伦","path":"/china/maikailun/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"摩根","path":"/china/mogen/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"纳智捷","path":"/china/nazhijie/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"欧朗","path":"/china/oulang/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"欧宝","path":"/china/oubao/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"讴歌","path":"/china/zuoge/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"起亚","path":"/china/qiya/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"奇瑞","path":"/china/qirui/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"启辰","path":"/china/qichen/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"瑞麒","path":"/china/ruizuo/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"荣威","path":"/china/rongwei/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"日产","path":"/china/richan/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"萨博","path":"/china/sabo/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"斯巴鲁","path":"/china/sibalu/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"世爵","path":"/china/shijue/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"斯柯达","path":"/china/sikeda/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"三菱","path":"/china/sanling/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"双龙","path":"/china/shuanglong/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"smart","path":"/china/smart/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"双环","path":"/china/shuanghuan/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"绅宝","path":"/china/shenbao/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"陕汽通家","path":"/china/shanqitongjia/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"思铭","path":"/china/siming/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"上汽大通","path":"/china/shangqidatong/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"特斯拉","path":"/china/tesila/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"五十铃","path":"/china/wushiling/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"五菱汽车","path":"/china/wulingqiche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"威麟","path":"/china/weizuo/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"威兹曼","path":"/china/weiziman/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"沃尔沃","path":"/china/woerwo/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"雪佛兰","path":"/china/xuefolan/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"雪铁龙","path":"/china/xuetielong/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"现代","path":"/china/xiandai/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"西雅特","path":"/china/xiyate/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"新凯","path":"/china/xinkai/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"一汽","path":"/china/yiqi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"野马汽车","path":"/china/yemaqiche/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"依维柯","path":"/china/yiweike/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"永源","path":"/china/yongyuan/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"英菲尼迪","path":"/china/yingfeinidi/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"中兴","path":"/china/zhongxing/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"中华","path":"/china/zhonghua/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"众泰","path":"/china/zhongtai/a0_0msdgscncgpi1lt1ocspex/"},
{"name":"知豆","path":"/china/zhidou/a0_0msdgscncgpi1lt1ocspex/"}]


var cities = ["安徽,/anhui/",
	      "北京,/beijing/",
	      "重庆,/chongqing/",
	      "福建,/fujian/",
	      "广东,/guangdong/",
	      "广西,/guangxi/",
	      "贵州,/guizhou/",
	      "甘肃,/gansu/",
	      "海南,/hainan/",
	      "河南,/henan/",
	      "湖北,/hubei/",
	      "湖南,/hunan/",
	      "河北,/hebei/",
	      "黑龙江,/heilongjiang/",
	      "江苏,/jiangsu/",
	      "江西,/jiangxi/",
	      "吉林,/jilin/",
	      "辽宁,/liaoning/",
	      "内蒙古,/namenggu/",
	      "宁夏,/ningxia/",
	      "青海,/qinghai/",
	      "陕西,/shan_xi/",
	      "四川,/sichuan/",
	      "上海,/shanghai/",
	      "山西,/shanxi/",
	      "山东,/shandong/",
	      "天津,/tianjin/",
	      "新疆,/xinjiang/",
	      "西藏,/xizang/",
	      "云南,/yunnan/",
	      "浙江,/zhejiang/"];

var cheerio = require('cheerio')
var fs = require('fs')
var helper = require('../../helpers/webhelper.js')

var logger = require('winston')
var env = process.env.NODE_ENV || "development"
logger.add(logger.transports.File, { filename: '../../log/athmershou.log',logstash:true ,handleExceptions: true});
if(env==="production"){
    logger.remove(logger.transports.Console);
}

var godotTransport = require("winston-godot")
var godot = require("godot")
var godotServer = require("../../config.json")[env].godotServer;
var client = godot.createClient(godotServer);
client.connect(godotServer.port);
logger.add(godotTransport, {godot:client, service:"athmershou"});//service名称需要更改

var ershou = function(){
    this.resultDir = "../../result/auto/";
    this.dataDir = '../../appdata/';
    this.resultFile = "athmershou_"+new Date().toString()+".csv";
    this.progressFile = "athmershou_progress_"+new Date().toString()+".txt";
    this.done = {};
    this.curPageIdx = 1;
    this.tasks = [];
    this.pageLimit = 300;
}

ershou.prototype.init = function(){
    if(fs.existsSync(this.resultDir+this.progressFile)){
	fs.readFileSync(this.resultDir+this.progressFile).toString().split('\n').reduce(function(pre,cur){
	    if(cur){
		pre[cur]=true;
	    }
	    return pre;
	},this.done);
    }
    
    for(var i=0;i<brands.length;i++){
	for(var j=0;j<cities.length;j++){
	    var vals = cities[j].split(',');
	    this.tasks.push({path:brands[i].path.replace(/\/china\//,vals[1]),name:brands[i].name,page:1,city:vals[0]});
	}
    }//URL,品牌,车系,车型,价格,里程,上牌时间,是否认证,商家名称,省份,城市
    if(!fs.existsSync(this.resultDir+this.resultFile)){
    	fs.writeFileSync(this.resultDir+this.resultFile, "\ufeffURL,品牌,车系,车型,价格,里程,上牌时间,是否认证,商家名称,省份,城市\n");
    }
    var arguments = process.argv.splice(2);
    var start = Number(arguments[0]) || 0;
    var len = Number(arguments[1]) || this.tasks.length;
    //前闭后开区间
    this.tasks = this.tasks.slice(start,start+len);
    logger.info("[INFO] task count: %d",this.tasks.length);
}

ershou.prototype.start = function(){
    this.init();
    this.wgetList();
}

ershou.prototype.wgetList = function(t){
    if(!t){
	var t = null;
	do{
	    t = this.tasks.shift();
	}
	while(this.tasks.length && this.done[t.name])
	if(!t){
	    logger.info("[DONE] job done");
	    logger.remove(godotTransport);
	    client.close();
	    return;
	}
    }
    
    var host = "www.che168.com";
    var path = t.path;
    var strArray = t.path.split('');
    strArray.splice(-3,0,t.page);
    
    var opt = null;
    opt = new helper.basic_options(host,strArray.join(""));
    opt.agent = false;
    
    logger.info("[GET ] %s,%d,%s,%s",t.name,t.page,opt.path,t.city);
    helper.request_data(opt,null,function(data,args,res){
	that.processList(data,args,res);
    },t);
}
var Task = function(){
    this.max=10;
    this.len=0;
    this.tasks = [];
}
Task.prototype.onEnd = function(){
    
}
Task.prototype.onStart = function(){
    
}
Task.prototype.add = function(ts){
    if(Array.isArray(ts)){
	this.tasks.concat(ts);
    }
}
Task.prototype.invoke = function(){
    
}

ershou.prototype.processList = function(data,args,res){
    if(!data){
	logger.error("[ERROR] data empty");
	setTimeout(function(){
	    that.wgetList(args[0]);
	},3000);
	return;
    }
    var $ = cheerio.load(data);
    var records=[];
    $(".piclist-big ul li .list-box").each(function(){
	var tit = $(".pic-big-tx .title > a",this).attr("title");
	var uri = $(".pic-big-tx .title > a",this).attr("href");
	var vals = tit && tit.split(" ");
	var model='',config='';
	if(vals){
	    if(vals.length>0){
		var model = vals[0];
	    }
	    if(vals.length>1){
		vals.shift();
		var config = vals.join(" ");
	    }
	}
	
	var price = $("span.price-num span",this).text();
	var audit = $(".pic-big-tx .icon-list i.icon20.icon20-car",this).length;
	var provider = $(".pic-big-tx .com-name a",this).text().trim();
	if(!provider){
	    provider = "个人";
	}
	var km = $(".km-box span",this).eq(0).text();
	var year = $(".km-box span",this).eq(1).text();
	var ct = $("div.com-name span.city",this).text().trim();
	//var city = $(".pic-big-tx .com-name span.city",this).text().trim();
	records.push([uri,args[0].name,model,config,price,km,year,audit?"Y":"N",provider,args[0].city,ct].join(','));
    });
    if(records.length>0){
    	fs.appendFileSync(this.resultDir+this.resultFile,records.join("\n")+"\n");
    }
    
    if($("div.page a.page-item-next").length && args[0].page<this.pageLimit){
	args[0].page++;
	setTimeout(function(){
	    that.wgetList(args[0]);
	},2000);
    }else{
	logger.info("[DONE] %s",args[0].name);
	fs.appendFileSync(this.resultDir+this.progressFile,args[0].name+"\n");
	// setTimeout(function(){
	//     that.wgetList();
	// },3000);
	that.wgetList();
    }
}

var that = new ershou();
that.start();