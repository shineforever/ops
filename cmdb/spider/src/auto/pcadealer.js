var brands = [{"name":"AC宝马","path":"/shangjia/c0/nb693/"},
{"name":"AMG","path":"/shangjia/c0/nb959/"},
{"name":"阿斯顿马丁","path":"/shangjia/c0/nb62/"},
{"name":"奥迪","path": "/shangjia/c0/nb1/"},
{"name":"巴博斯","path":"/shangjia/c0/nb723/"},
{"name":"保时捷","path":"/shangjia/c0/nb44/"},
{"name":"宝骏","path":"/shangjia/c0/nb582/"},
{"name":"宝马","path":"/shangjia/c0/nb20/"},
{"name":"北京汽车","path":"/shangjia/c0/nb593/"},
{"name":"北汽幻速","path":"/shangjia/c0/nb898/"},
{"name":"北汽威旺","path":"/shangjia/c0/nb643/"},
{"name":"北汽新能源","path":"/shangjia/c0/nb950/"},
{"name":"北汽制造","path":"/shangjia/c0/nb122/"},
{"name":"奔驰","path":"/shangjia/c0/nb4/"},
{"name":"奔腾","path":"/shangjia/c0/nb306/"},
{"name":"本田","path":"/shangjia/c0/nb3/"},
{"name":"比亚迪","path":"/shangjia/c0/nb107/"},
{"name":"标致","path":"/shangjia/c0/nb41/"},
{"name":"别克","path":"/shangjia/c0/nb7/"},
{"name":"宾利","path":"/shangjia/c0/nb45/"},
{"name":"布加迪","path":"/shangjia/c0/nb63/"},
{"name":"昌河","path":"/shangjia/c0/nb75/"},
{"name":"长安","path":"/shangjia/c0/nb124/"},
{"name":"长安商用","path":"/shangjia/c0/nb613/"},
{"name":"长城","path":"/shangjia/c0/nb110/"},
{"name":"DS","path":"/shangjia/c0/nb754/"},
{"name":"大众","path":"/shangjia/c0/nb2/"},
{"name":"道奇","path":"/shangjia/c0/nb72/"},
{"name":"东风","path":"/shangjia/c0/nb111/"},
{"name":"东风风度","path":"/shangjia/c0/nb877/"},
{"name":"东风风神","path":"/shangjia/c0/nb581/"},
{"name":"东风风行","path":"/shangjia/c0/nb949/"},
{"name":"东风小康","path":"/shangjia/c0/nb856/"},
{"name":"东南","path":"/shangjia/c0/nb16/"},
{"name":"法拉利","path":"/shangjia/c0/nb61/"},
{"name":"菲亚特","path":"/shangjia/c0/nb18/"},
{"name":"丰田","path":"/shangjia/c0/nb10/"},
{"name":"福迪","path":"/shangjia/c0/nb116/"},
{"name":"福汽启腾","path":"/shangjia/c0/nb878/"},
{"name":"福特","path":"/shangjia/c0/nb21/"},
{"name":"福田","path":"/shangjia/c0/nb103/"},
{"name":"GMC","path":"/shangjia/c0/nb265/"},
{"name":"观致","path":"/shangjia/c0/nb824/"},
{"name":"光冈","path":"/shangjia/c0/nb567/"},
{"name":"广汽传祺","path":"/shangjia/c0/nb571/"},
{"name":"广汽吉奥","path":"/shangjia/c0/nb195/"},
{"name":"哈飞","path":"/shangjia/c0/nb82/"},
{"name":"哈弗","path":"/shangjia/c0/nb845/"},
{"name":"海格","path":"/shangjia/c0/nb876/"},
{"name":"海马","path":"/shangjia/c0/nb8/"},
{"name":"海马郑州","path":"/shangjia/c0/nb583/"},
{"name":"悍马","path":"/shangjia/c0/nb59/"},
{"name":"恒天","path":"/shangjia/c0/nb855/"},
{"name":"红旗","path":"/shangjia/c0/nb396/"},
{"name":"华普","path":"/shangjia/c0/nb81/"},
{"name":"华泰","path":"/shangjia/c0/nb115/"},
{"name":"黄海","path":"/shangjia/c0/nb133/"},
{"name":"Jeep","path":"/shangjia/c0/nb38/"},
{"name":"吉利汽车","path":"/shangjia/c0/nb13/"},
{"name":"江淮","path":"/shangjia/c0/nb78/"},
{"name":"江铃","path":"/shangjia/c0/nb101/"},
{"name":"捷豹","path":"/shangjia/c0/nb26/"},
{"name":"金杯","path":"/shangjia/c0/nb83/"},
{"name":"金龙汽车","path":"/shangjia/c0/nb355/"},
{"name":"金旅","path":"/shangjia/c0/nb114/"},
{"name":"九龙","path":"/shangjia/c0/nb568/"},
{"name":"卡尔森","path":"/shangjia/c0/nb704/"},
{"name":"开瑞","path":"/shangjia/c0/nb578/"},
{"name":"凯迪拉克","path":"/shangjia/c0/nb70/"},
{"name":"凯翼","path":"/shangjia/c0/nb970/"},
{"name":"科尼赛克","path":"/shangjia/c0/nb570/"},
{"name":"克莱斯勒","path":"/shangjia/c0/nb39/"},
{"name":"兰博基尼","path":"/shangjia/c0/nb64/"},
{"name":"劳伦士","path":"/shangjia/c0/nb663/"},
{"name":"劳斯莱斯","path":"/shangjia/c0/nb47/"},
{"name":"雷克萨斯","path":"/shangjia/c0/nb30/"},
{"name":"雷诺","path":"/shangjia/c0/nb40/"},
{"name":"理念","path":"/shangjia/c0/nb604/"},
{"name":"力帆","path":"/shangjia/c0/nb305/"},
{"name":"莲花","path":"/shangjia/c0/nb46/"},
{"name":"猎豹汽车","path":"/shangjia/c0/nb58/"},
{"name":"林肯","path":"/shangjia/c0/nb66/"},
{"name":"铃木","path":"/shangjia/c0/nb73/"},
{"name":"路虎","path":"/shangjia/c0/nb29/"},
{"name":"路特斯","path":"/shangjia/c0/nb653/"},
{"name":"陆风","path":"/shangjia/c0/nb569/"},
{"name":"MG","path":"/shangjia/c0/nb345/"},
{"name":"MINI","path":"/shangjia/c0/nb205/"},
{"name":"玛莎拉蒂","path":"/shangjia/c0/nb316/"},
{"name":"马自达","path":"/shangjia/c0/nb17/"},
{"name":"迈巴赫","path":"/shangjia/c0/nb387/"},
{"name":"迈凯伦","path":"/shangjia/c0/nb715/"},
{"name":"摩根","path":"/shangjia/c0/nb908/"},
{"name":"纳智捷","path":"/shangjia/c0/nb623/"},
{"name":"欧宝","path":"/shangjia/c0/nb22/"},
{"name":"欧朗","path":"/shangjia/c0/nb703/"},
{"name":"讴歌","path":"/shangjia/c0/nb140/"},
{"name":"奇瑞","path":"/shangjia/c0/nb57/"},
{"name":"起亚","path":"/shangjia/c0/nb12/"},
{"name":"启辰","path":"/shangjia/c0/nb633/"},
{"name":"日产","path":"/shangjia/c0/nb15/"},
{"name":"荣威 ","path":"/shangjia/c0/nb365/"},
{"name":"瑞麒","path":"/shangjia/c0/nb580/"},
{"name":"Smart","path":"/shangjia/c0/nb603/"},
{"name":"萨博","path":"/shangjia/c0/nb23/"},
{"name":"三菱","path":"/shangjia/c0/nb32/"},
{"name":"上汽大通MAXUS","path":"/shangjia/c0/nb673/"},
{"name":"绅宝","path":"/shangjia/c0/nb814/"},
{"name":"世爵","path":"/shangjia/c0/nb546/"},
{"name":"双环","path":"/shangjia/c0/nb119/"},
{"name":"双龙","path":"/shangjia/c0/nb53/"},
{"name":"斯巴鲁","path":"/shangjia/c0/nb49/"},
{"name":"斯柯达","path":"/shangjia/c0/nb69/"},
{"name":"思铭","path":"/shangjia/c0/nb733/"},
{"name":"泰卡特","path":"/shangjia/c0/nb969/"},
{"name":"威麟","path":"/shangjia/c0/nb579/"},
{"name":"沃尔沃","path":"/shangjia/c0/nb24/"},
{"name":"五菱","path":"/shangjia/c0/nb118/"},
{"name":"五十铃","path":"/shangjia/c0/nb918/"},
{"name":"西雅特","path":"/shangjia/c0/nb154/"},
{"name":"现代","path":"/shangjia/c0/nb34/"},
{"name":"雪佛兰","path":"/shangjia/c0/nb225/"},
{"name":"雪铁龙","path":"/shangjia/c0/nb6/"},
{"name":"野马汽车","path":"/shangjia/c0/nb516/"},
{"name":"一汽","path":"/shangjia/c0/nb9/"},
{"name":"依维柯","path":"/shangjia/c0/nb132/"},
{"name":"英菲尼迪","path":"/shangjia/c0/nb28/"},
{"name":"英致","path":"/shangjia/c0/nb919/"},
{"name":"永源","path":"/shangjia/c0/nb275/"},
{"name":"知豆","path":"/shangjia/c0/nb929/"},
{"name":"中华","path":"/shangjia/c0/nb104/"},
{"name":"中欧","path":"/shangjia/c0/nb506/"},
{"name":"中兴","path":"/shangjia/c0/nb125/"},
{"name":"众泰","path":"/shangjia/c0/nb307/"}]


var fs = require('fs')
var helper = require('../../helpers/webhelper.js')
var cheerio = require('cheerio')
var url = require('url')
var Crawler = require("node-webcrawler")
var seenreq = require("seenreq")

var logger = require('winston')

var env = process.env.NODE_ENV || "development"

var godotTransport = require("winston-godot")
var godot = require("godot")
var godotServer = require("../../config.json")[env].godotServer;
var client = godot.createClient(godotServer);
client.connect(godotServer.port);
logger.add(godotTransport, {godot:client, service:"pcadealer"});//service名称需要更改

logger.add(logger.transports.File, { filename: '../../log/pcadealer.log',logstash:true,handleExceptions:true });
if(env==="production"){
    logger.remove(logger.transports.Console);
}

var Dealer = function(){
    this.resultDir = "../../result/auto/";
    this.dataDir = '../../appdata/';
    this.resultFile = "pcadealer_"+new Date().toString()+".csv";
    this.progressFile = "pcadealer_progress_"+new Date().toString()+".txt";
    this.done = {};
    this.curPageIdx = 1;
    this.tasks = [];
    this.c = new Crawler({
	maxConnections:1,
	forceUTF8:true,
	userAgent:require("../../ua.json").userAgents,
	rotateUA:true
    });
}

Dealer.prototype.init = function(){
    if(!fs.existsSync(this.resultDir+this.resultFile)){
    	fs.writeFileSync(this.resultDir+this.resultFile, "\ufeff品牌,名称,城市,电话,店铺属性,认证\n");
    }
    if(fs.existsSync(this.resultDir+this.progressFile)){
	fs.readFileSync(this.resultDir+this.progressFile).toString().split('\n').reduce(function(pre,cur){
	    if(cur){
		pre[cur]=true;
	    }
	    return pre;
	},this.done);
    }
    for(var i=0;i<brands.length;i++){
	var brand = brands[i];
	this.tasks.push({path:brand.path,name:brand.name,page:1});
    }
    logger.info("task count: %d",this.tasks.length);
}

Dealer.prototype.start = function(){
    this.init();
    this.wgetList();
}

Dealer.prototype.wgetList = function(t){
    if(!t){
	var t = null;
	do{
	    t = this.tasks.shift();
	}
	while(this.tasks.length && this.done[t.name])
	if(!t){
	    logger.info("job done");
	    logger.remove(godotTransport);
	    client.close();
	    return;
	}
    }
    
    var url = "http://price.pcauto.com.cn"+t.path + "p"+t.page+".html";
    logger.info("%s,%d/%d",t.name,t.page,t.maxPage);
    this.c.queue({uri:url,callback:function(err,result,$){
	if(err){
	    logger.error(err);
	}else{
	    that.processList(result,$);
	}
    },t:t});
}

var Task = function(){
    this.max=10;
    this.len=0;
    this.tasks = [];
}
Task.prototype.onEnd = function(){
    
}
Task.prototype.onStart = function(){
    
}
Task.prototype.add = function(ts){
    if(Array.isArray(ts)){
	this.tasks.concat(ts);
    }
}
Task.prototype.invoke = function(){
    
}
    
Dealer.prototype.processList = function(result,$){
    var t = result.options.t;
    if(t.maxPage==undefined){
	var nextPage = $(".pcauto_page a.next").last();
	if(nextPage){
	    t.maxPage = Number(nextPage.prev().text());
	}else{
	    t.maxPage = 1;
	}
    }
    
    var records = [];
    $("ul.yStore > li").each(function(){
	var titleLink = $("div.divYSa dl dd i",this).first();
	var type = $("span.dsTitle",titleLink).text();
	type = type && type.replace(/[：:]/g,"");
	
	var name = $("strong",titleLink).text().trim();
	name = name && name.replace(/[,，]/g,"");
	
	var audit = $("img",titleLink).length;
	var phone = $("div.divYSa dl dd i.tel strong.red",this).text();
	if(!phone){
	    phone = $("div.divYSa dl dd i.tel",this).text();
	}
	phone = phone && phone.replace(/[\s电话:：]/g,"");
	var city = $("div.divYSb i",this).eq(1).text();
	var o = [t.name,name,city,phone,type,audit?"Y":"N"].join(',');
	records.push(o);
    });

    if (records.length>0) {
    	fs.appendFileSync(this.resultDir+this.resultFile,records.join('\n')+'\n');
    };
    
    if(t.page<t.maxPage){
	t.page++;
	setTimeout(function(){
	    that.wgetList(t);
	},0);
    }else{
	logger.info("%s",t.name);
	fs.appendFileSync(this.resultDir+this.progressFile,t.name+"\n");
	this.wgetList();
    }
}

var instance = new Dealer();
var that = instance;
instance.start();
